name: Telegram Bot with Ngrok

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests pyngrok

      - name: Run Telegram Bot with Ngrok
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          python - <<'PY'
          import os, requests, time
          from http.server import SimpleHTTPRequestHandler, HTTPServer
          import threading
          from pyngrok import ngrok

          TOKEN = os.environ['TELEGRAM_BOT_TOKEN']
          API = f"https://api.telegram.org/bot{TOKEN}"

          # üìå ÿ±ÿßŸá‚ÄåÿßŸÜÿØÿßÿ≤€å HTTP Server ŸÑŸà⁄©ÿßŸÑ
          def start_server():
              httpd = HTTPServer(('0.0.0.0', 8080), SimpleHTTPRequestHandler)
              httpd.serve_forever()

          threading.Thread(target=start_server, daemon=True).start()

          # üìå Ngrok
          auth = os.environ.get("NGROK_AUTH_TOKEN")
          if auth:
              ngrok.set_auth_token(auth)
          public_url = ngrok.connect(8080, "http")
          print("üåç Public URL:", public_url)

          def get_updates(offset=None):
              r = requests.get(f"{API}/getUpdates", params={"timeout": 30, "offset": offset})
              return r.json().get("result", [])

          def send_message(chat_id, text):
              requests.post(f"{API}/sendMessage", data={"chat_id": chat_id, "text": text})

          def download_file(file_id, filename):
              g = requests.get(f"{API}/getFile?file_id={file_id}").json()
              file_path = g["result"]["file_path"]
              url = f"https://api.telegram.org/file/bot{TOKEN}/{file_path}"
              data = requests.get(url).content
              with open(filename, "wb") as f:
                  f.write(data)
              return filename

          def handle_media(chat_id, media_type, msg):
              filename = None
              if media_type == "document":
                  file_id = msg["document"]["file_id"]
                  filename = msg["document"]["file_name"]
              elif media_type == "video":
                  file_id = msg["video"]["file_id"]
                  filename = "video.mp4"
              elif media_type == "photo":
                  file_id = msg["photo"][-1]["file_id"]  # ÿ¢ÿÆÿ±€åŸÜ ⁄©€åŸÅ€åÿ™
                  filename = "photo.jpg"
              else:
                  send_message(chat_id, "‚ùå ŸÜŸàÿπ ŸÅÿß€åŸÑ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ.")
                  return

              local_file = download_file(file_id, filename)
              link = f"{public_url}/{local_file}"
              send_message(chat_id, f"üì• ŸÑ€åŸÜ⁄© ÿØÿßŸÜŸÑŸàÿØ:\n{link}")

          print("ü§ñ Bot started, running for ~1 hour...")
          offset = None
          start_time = time.time()

          while True:
              updates = get_updates(offset)
              for u in updates:
                  offset = u["update_id"] + 1
                  msg = u.get("message", {})
                  chat_id = msg.get("chat", {}).get("id")

                  if "text" in msg and msg["text"] == "/start":
                      send_message(chat_id, "ÿ≥ŸÑÿßŸÖ üëã ŸÅÿß€åŸÑÿå Ÿà€åÿØ€åŸà €åÿß ÿπ⁄©ÿ≥ ÿ±Ÿà ÿ®ŸÅÿ±ÿ≥ÿ™ ÿ™ÿß ŸÑ€åŸÜ⁄©ÿ¥Ÿà ÿ®Ÿáÿ™ ÿ®ÿØŸÖ.")

                  if "document" in msg:
                      handle_media(chat_id, "document", msg)
                  elif "video" in msg:
                      handle_media(chat_id, "video", msg)
                  elif "photo" in msg:
                      handle_media(chat_id, "photo", msg)

              if time.time() - start_time > 3600:  # ‚è∞ €å⁄© ÿ≥ÿßÿπÿ™
                  print("‚è∞ Time is up, bot shutting down.")
                  break
              time.sleep(2)
          PY
