name: Free Cloud File Server
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # ูุฑ ถ ุณุงุนุช

jobs:
  file-server:
    runs-on: ubuntu-latest
    steps:
    - name: Setup Python HTTP Server
      run: |
        # ุงุฌุงุฏ ฺฉ ูุงู ููููู ุจุฑุง ุชุณุช
        echo "๐ ุงุฌุงุฏ ุณุฑูุฑ ูุงู ูููุช..."
        cat > share-file.txt << EOF
        ูุงู ุชุณุช ุงุฌุงุฏ ุดุฏู ุฏุฑ $(date)
        ุญุฌู: 1KB
        ุงุฌุงุฏ ุดุฏู ุชูุณุท GitHub File Server
        ุจุฑุง ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ูููุช
        EOF

        # ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ HTTP
        python3 -m http.server 8000 &
        SERVER_PID=$!
        echo $SERVER_PID > server.pid
        sleep 3

    - name: Setup Ngrok Tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok http 8000 --log=stdout > ngrok.log 2>&1 &
        sleep 15

    - name: Get Public Link
      run: |
        # ุฏุฑุงูุช ููฺฉ ุนููู
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
        FILE_URL="${PUBLIC_URL}/share-file.txt"
        
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
        echo "FILE_URL=$FILE_URL" >> $GITHUB_ENV

    - name: Send to Telegram
      run: |
        # ุงุฑุณุงู ููฺฉ ุจู ุชูฺฏุฑุงู
        curl -s -X POST \
          "https://api.telegram.org/bot7897337548:AAGudjNDkUM5pUWx93mdc6kFBrSqusuj_NA/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=๐ ููฺฉ ูุงู: ${{ env.FILE_URL }}" \
          -d "parse_mode=HTML"

    - name: Display Info
      run: |
        echo "=========================================="
        echo "๐ FILE SERVER ACTIVE!"
        echo "=========================================="
        echo "๐ Public URL: ${{ env.PUBLIC_URL }}"
        echo "๐ File URL: ${{ env.FILE_URL }}"
        echo "โฐ Valid for: 6 hours"
        echo ""
        echo "๐ก ุจุฑุง ุขูพููุฏ ูุงูโูุง ุฎูุฏ:"
        echo "1. ูุงู ุฑุง ุฏุฑ ุฑูพูุฒุชูุฑ ูุฑุงุฑ ุฏูุฏ"
        echo "2. ูุงู ูุงู ุฑุง ุฌุงฺฏุฒู 'share-file.txt' ฺฉูุฏ"
        echo "3. workflow ุฑุง ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูุฏ"
        echo "=========================================="

    - name: Wait for file requests
      run: |
        echo "๐ ุณุฑูุฑ ูุนุงู ุงุณุช ู ููุชุธุฑ ุฏุฑุฎูุงุณุชโูุง..."
        echo "๐ก ุฏุฑ ุญุงู ุณุฑูุณโุฏู ุฑู ูพูุฑุช 8000"
        echo "๐ ููฺฉ: ${{ env.PUBLIC_URL }}"
        
        # ูฺฏูโุฏุงุฑ ุณุฑูุฑ ุจุฑุง ถ ุณุงุนุช
        sleep 21600
