name: Telegram File to Public Link

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to file in repo'
        required: true
        default: 'build/output.zip'
      chat_id:
        description: 'Telegram chat id or channel'
        required: true
        default: '@yourchannel'

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install requests pyngrok

      - name: Upload file to Telegram & Download back
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          python - <<'PY'
          import os, requests

          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = "${{ github.event.inputs.chat_id }}"
          file_path = "${{ github.workspace }}/${{ github.event.inputs.file_path }}"

          # sendDocument
          r = requests.post(f"https://api.telegram.org/bot{token}/sendDocument",
                            data={"chat_id": chat_id},
                            files={"document": open(file_path,"rb")})
          r.raise_for_status()
          file_id = r.json()["result"]["document"]["file_id"]

          # getFile
          g = requests.get(f"https://api.telegram.org/bot{token}/getFile?file_id={file_id}")
          g.raise_for_status()
          file_path_tg = g.json()["result"]["file_path"]

          # download file back
          url = f"https://api.telegram.org/file/bot{token}/{file_path_tg}"
          f = requests.get(url)
          with open("downloaded_file", "wb") as out:
              out.write(f.content)
          print("Downloaded file from Telegram")
          PY

      - name: Start HTTP server with Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          python -m http.server 8080 &
          sleep 2
          python - <<'PY'
          from pyngrok import ngrok
          import os
          auth = os.environ.get("NGROK_AUTH_TOKEN")
          if auth:
              ngrok.set_auth_token(auth)
          public_url = ngrok.connect(8080, "http")
          print("Public URL:", public_url)
          with open("public_link.txt","w") as f:
              f.write(str(public_url))
          PY

      - name: Show Public Link
        run: cat public_link.txt
